<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø·Ù„Ø§ - ØªÙˆÙ…Ø§Ù† (Ø¨Ø§ Cache)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ spinner, status-box, input-autofilled Ù…Ø§Ù†Ù†Ø¯ Ù‚Ø¨Ù„ */
        .status-box {
            min-height: 60px; line-height: 1.5; background-color: #f9fafb;
            border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 0.5rem;
            overflow-y: auto; max-height: 150px;
        }
        .status-box p { margin-bottom: 0.25rem; font-size: 0.75rem; }
        .status-box p:last-child { margin-bottom: 0; }
        .input-autofilled {
            background-color: #f0fff4; transition: background-color 0.3s ease;
        }
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%;
            border-top-color: #ffffff; width: 1rem; height: 1rem;
            animation: spin 1s linear infinite; display: inline-block;
            vertical-align: middle; margin-left: 0.5rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden { display: none; }
        /* Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ù…Ø­Ùˆ Ø´Ø¯Ù† Ø¨Ø±Ø§ÛŒ Ù†ØªØ§ÛŒØ¬ */
        #results.fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="max-w-2xl mx-auto">
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-4">
            <strong>ØªÙˆØ¬Ù‡:</strong>
            <p class="mb-0">Ø§ÛŒÙ† Ø§Ø¨Ø²Ø§Ø± ÙÙ‚Ø· Ø¯Ø± Ø¬Ù‡Øª Ø±ÙˆØ´Ù†Ú¯Ø±ÛŒ Ø§Ø³Øª Ùˆ Ø¬Ù†Ø¨Ù‡â€ŒÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø¯Ø§Ø±Ø¯ Ùˆ Ø§ØµÙ„Ø§ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø®Ø±ÛŒØ¯ ÛŒØ§ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ù†ÛŒØ³Øª. ÙÙ‚Ø· ÙˆØ³ÛŒÙ„Ù‡ â€ŒØ§ÛŒØ³Øª  ØªØ§ Ø¨Ø§ Ø¯Ø± Ù†Ø¸Ø± Ú¯Ø±ÙØªÙ† Ø§Ø®Ø¨Ø§Ø± Ø¯Ù„Ø§Ø± Ùˆ Ø·Ù„Ø§ Ùˆ ... ØªØµÙ…ÛŒÙ… Ø¨Ù‡ØªØ±ÛŒ Ø¨Ú¯ÛŒØ±ÛŒØ¯.</p>
        </div>

        <div class="bg-white p-4 rounded-lg shadow-md mb-4">
            <div class="grid grid-cols-1 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ù‚ÛŒÙ…Øª Ø§Ù†Ø³ Ø¬Ù‡Ø§Ù†ÛŒ Ø·Ù„Ø§ (Ø¯Ù„Ø§Ø±)</label>
                    <div class="flex gap-2 items-start">
                        <div class="flex-1">
                            <input type="number" id="ouncePrice" oninput="handleManualInput(this); saveInputs();" class="block w-full rounded-md border-gray-300 shadow-sm" placeholder="Ù…Ø«Ø§Ù„: 2350.50">
                            <div id="goldStatus" class="mt-1 status-box"></div>
                        </div>
                        <button id="fetchGoldButton" onclick="fetchData('gold', 'ouncePrice', 'goldStatus')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg h-fit whitespace-nowrap flex items-center justify-center min-w-[120px]">
                            <span class="button-text">Ø¯Ø±ÛŒØ§ÙØª Ø®ÙˆØ¯Ú©Ø§Ø±</span><span class="spinner hidden"></span>
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ù‚ÛŒÙ…Øª Ø¯Ù„Ø§Ø± Ø¨Ù‡ **ØªÙˆÙ…Ø§Ù†** (Ø¨Ø§Ø²Ø§Ø± Ø¢Ø²Ø§Ø¯)</label>
                    <div class="flex gap-2 items-start">
                        <div class="flex-1">
                            <input type="number" id="dollarPrice" oninput="handleManualInput(this); saveInputs();" class="block w-full rounded-md border-gray-300 shadow-sm" placeholder="Ù…Ø«Ø§Ù„: 58500">
                            <div id="dollarStatus" class="mt-1 status-box"></div>
                        </div>
                        <button id="fetchDollarButton" onclick="fetchData('dollar', 'dollarPrice', 'dollarStatus')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg h-fit whitespace-nowrap flex items-center justify-center min-w-[120px]">
                            <span class="button-text">Ø¯Ø±ÛŒØ§ÙØª Ø®ÙˆØ¯Ú©Ø§Ø±</span><span class="spinner hidden"></span>
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ù‚ÛŒÙ…Øª Ù‡Ø± Ú¯Ø±Ù… Ø·Ù„Ø§ÛŒ 18 Ø¹ÛŒØ§Ø± Ø§ÛŒØ±Ø§Ù† (**ØªÙˆÙ…Ø§Ù†**)</label>
                    <div class="flex gap-2 items-start">
                        <div class="flex-1">
                            <input type="number" id="iranGold" oninput="handleManualInput(this); saveInputs();" class="block w-full rounded-md border-gray-300 shadow-sm" placeholder="Ù…Ø«Ø§Ù„: 3450000">
                            <div id="iranGoldStatus" class="mt-1 status-box"></div>
                        </div>
                        <button id="fetchIranGoldButton" onclick="fetchData('iranGold', 'iranGold', 'iranGoldStatus')" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg h-fit whitespace-nowrap flex items-center justify-center min-w-[120px]">
                            <span class="button-text">Ø¯Ø±ÛŒØ§ÙØª Ø®ÙˆØ¯Ú©Ø§Ø±</span><span class="spinner hidden"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>


        <div class="grid grid-cols-2 gap-4 mb-4">
            <button onclick="calculate()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ùˆ ØªØ­Ù„ÛŒÙ„</button>
            <button onclick="resetAll()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ ÙØ±Ù…</button>
        </div>
        <div id="results" class="space-y-4"></div>
      
    </div>

    <script>
        // --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª ---
        const CORS_PROXIES = [
            'https://api.allorigins.win/get?url=', 'https://corsproxy.io/?', 'https://cors.bridged.cc/',
            'https://thingproxy.freeboard.io/fetch/', 'https://api.codetabs.com/v1/proxy?quest=',
            'https://cors-bypass.amano.workers.dev/?url='
        ];
        let currentProxyIndex = 0;
        const SOURCES = {
            'gold': [
                { name: 'TGJU.org (Ounce)', url: 'https://www.tgju.org/profile/ons', selector: 'span[data-col="info.last_trade.PDrCotVal"]', parser: (text) => parseFloat(text.replace(/[^0-9.]/g, '')) },
                { name: 'Mesghal.com (Ounce)', url: 'https://www.mesghal.com/', selector: '#ons_val', parser: (text) => parseFloat(text.replace(/[^0-9.]/g, '')) },
                { name: 'GoldPrice.org', url: 'https://www.goldprice.org/', selector: '.gpoticker-price', parser: (text) => parseFloat(text.replace(/[^0-9.]/g, '')) },
                { name: 'APMEX Spot Price', url: 'https://www.apmex.com/spot-prices/gold-prices', selector: 'div.spot-price-blocks a[href="/spot-prices/gold-prices"] .price', parser: (text) => parseFloat(text.replace(/[^0-9.]/g, '')) },
                { name: 'Kitco - Ask Price', url: 'https://www.kitco.com/', selector: '#sp-ask-usd', parser: (text) => parseFloat(text.replace(/[^0-9.]/g, '')) }
            ],
            'dollar': [
                { name: 'TGJU.org (Dollar)', url: 'https://www.tgju.org/profile/price_dollar_rl', selector: 'span[data-col="info.last_trade.PDrCotVal"]', parser: (text) => parseInt(text.replace(/,/g, ''), 10) },
                { name: 'Bonbast (Free Market)', url: 'https://bonbast.com/', selector: '#usd1', parser: (text) => parseInt(text.replace(/,/g, ''), 10) },
            ],
            'iranGold': [
                { name: 'TGJU.org (18 Ayar)', url: 'https://www.tgju.org/profile/geram18', selector: 'span[data-col="info.last_trade.PDrCotVal"]', parser: (text) => parseInt(text.replace(/,/g, ''), 10) },
                { name: 'Mesghal.com (18 Ayar)', url: 'https://www.mesghal.com/', selector: '#geram18_val', parser: (text) => parseInt(text.replace(/[^0-9]/g, ''), 10) }
            ]
        };
        const CACHE_DURATION_MS = 10 * 60 * 1000; // 10 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø¹ØªØ¨Ø§Ø± Ú©Ø´

        // --- ØªÙˆØ§Ø¨Ø¹ ---

        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId); if (!element) return;
            const maxLines = 7;
            const colorClasses = { info: 'text-blue-600', success: 'text-green-600 font-semibold', error: 'text-red-600', attempt: 'text-gray-500', cache: 'text-purple-600' }; // Added cache color
            const timestamp = new Date().toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit', second: '2-digit'});
            const newMessage = `<p class="${colorClasses[type] || 'text-gray-700'}">[${timestamp}] ${message}</p>`; // Fallback color
            element.innerHTML = newMessage + element.innerHTML;
            const lines = element.getElementsByTagName('p');
            while (lines.length > maxLines) { element.removeChild(lines[lines.length - 1]); }
        }

        function clearStatus(elementId) {
            const element = document.getElementById(elementId); if (element) { element.innerHTML = ''; }
        }

        function handleManualInput(inputElement) {
            inputElement.classList.remove('input-autofilled');
        }

        // Ø°Ø®ÛŒØ±Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± ÙˆØ±ÙˆØ¯ÛŒ Ø¯Ø± localStorage
        function saveInputs() {
            const ounce = document.getElementById('ouncePrice').value;
            const dollar = document.getElementById('dollarPrice').value;
            const iran = document.getElementById('iranGold').value;
            localStorage.setItem('lastOuncePrice', ounce);
            localStorage.setItem('lastDollarPrice', dollar);
            localStorage.setItem('lastIranGold', iran);
        }

        // Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ù…Ù‚Ø§Ø¯ÛŒØ± ÙˆØ±ÙˆØ¯ÛŒ Ø§Ø² localStorage Ø¯Ø± Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ ØµÙØ­Ù‡
        window.onload = function() {
            const lastOunce = localStorage.getItem('lastOuncePrice');
            const lastDollar = localStorage.getItem('lastDollarPrice');
            const lastIran = localStorage.getItem('lastIranGold');
            if (lastOunce) document.getElementById('ouncePrice').value = lastOunce;
            if (lastDollar) document.getElementById('dollarPrice').value = lastDollar;
            if (lastIran) document.getElementById('iranGold').value = lastIran;
        };

        async function fetchData(dataType, inputId, statusId) {
            const sources = SOURCES[dataType];
            const friendlyName = dataType === 'gold' ? 'Ø§Ù†Ø³' : dataType === 'dollar' ? 'Ø¯Ù„Ø§Ø±' : 'Ø·Ù„Ø§';

            if (!sources || sources.length === 0) {
                updateStatus(statusId, `âŒ Ù…Ù†Ø¨Ø¹ÛŒ Ø¨Ø±Ø§ÛŒ ${friendlyName} ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡`, 'error'); return;
            }

            const buttonId = `Workspace${dataType.charAt(0).toUpperCase() + dataType.slice(1)}Button`; // Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ID ĞºĞ½Ğ¾Ğ¿ĞºĞ¸
            const button = document.getElementById(buttonId);
            const buttonText = button?.querySelector('.button-text');
            const spinner = button?.querySelector('.spinner');
            if (button) button.disabled = true;
            if (buttonText) buttonText.classList.add('hidden');
            if (spinner) spinner.classList.remove('hidden');

            clearStatus(statusId);

            // --- Ø¨Ø±Ø±Ø³ÛŒ Cache ---
            const cacheKey = `cache_${dataType}`;
            try {
                const cachedItem = localStorage.getItem(cacheKey);
                if (cachedItem) {
                    const parsedCache = JSON.parse(cachedItem);
                    if (Date.now() - parsedCache.timestamp < CACHE_DURATION_MS) {
                        const cachedValue = parsedCache.value;
                        const inputElement = document.getElementById(inputId);
                        const displayValue = dataType === 'gold' ? Number(cachedValue).toFixed(2) : Number(cachedValue).toFixed(0);
                        inputElement.value = displayValue;
                        inputElement.classList.add('input-autofilled');
                        updateStatus(statusId, `âœ… Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø² Ø­Ø§ÙØ¸Ù‡ Ù¾Ù†Ù‡Ø§Ù† (Ù…Ù‚Ø¯Ø§Ø±: ${displayValue})`, 'cache');

                        if (button) button.disabled = false;
                        if (buttonText) buttonText.classList.remove('hidden');
                        if (spinner) spinner.classList.add('hidden');
                        return; // Ø§ØªÙ…Ø§Ù… Ú©Ø§Ø±
                    } else {
                        localStorage.removeItem(cacheKey);
                        updateStatus(statusId, `ğŸ—‘ï¸ Ø­Ø§ÙØ¸Ù‡ Ù¾Ù†Ù‡Ø§Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø¨ÙˆØ¯.`, 'info');
                    }
                }
            } catch(e) { console.error("Cache read error:", e); localStorage.removeItem(cacheKey); }
            // --- Ù¾Ø§ÛŒØ§Ù† Ø¨Ø±Ø±Ø³ÛŒ Cache ---

            updateStatus(statusId, `â³ Ø´Ø±ÙˆØ¹ Ø¯Ø±ÛŒØ§ÙØª ${friendlyName} Ø§Ø² Ø´Ø¨Ú©Ù‡...`, 'info');
            let success = false;
            let overallFailureMessage = `âŒ Ø¯Ø±ÛŒØ§ÙØª ${friendlyName} Ø§Ø² ØªÙ…Ø§Ù… Ù…Ù†Ø§Ø¨Ø¹ Ø´Ø¨Ú©Ù‡ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.`;

            for (const source of sources) {
                updateStatus(statusId, `ğŸ” ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø²: ${source.name}`, 'attempt');
                let proxySuccess = false;
                let lastErrorForSource = `Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ Ø¯Ø± ${source.name}`;

                for (let i = 0; i < CORS_PROXIES.length; i++) {
                    const proxyUrl = CORS_PROXIES[currentProxyIndex];
                    let fullUrl;
                    const needsEncoding = ['allorigins.win', 'codetabs.com', 'amano.workers.dev'].some(url => proxyUrl.includes(url));
                    fullUrl = needsEncoding ? `${proxyUrl}${encodeURIComponent(source.url)}` : `${proxyUrl}${source.url}`;

                    try {
                        const response = await fetch(fullUrl);
                        if (!response.ok) throw new Error(`Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ ${response.status} Ø§Ø² Ù¾Ø±ÙˆÚ©Ø³ÛŒ ${currentProxyIndex + 1}`);
                        let htmlContent;
                        if (proxyUrl.includes('allorigins.win')) {
                            const data = await response.json();
                            if (!data.contents) throw new Error(`Ù…Ø­ØªÙˆØ§ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø² allorigins`);
                            htmlContent = data.contents;
                        } else {
                            htmlContent = await response.text();
                        }
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(htmlContent, 'text/html');
                        const priceElement = doc.querySelector(source.selector);
                        if (!priceElement) throw new Error(`Ø³Ù„Ú©ØªÙˆØ± (${source.selector}) ÛŒØ§ÙØª Ù†Ø´Ø¯`);
                        const rawValue = priceElement.textContent.trim();
                        if (!rawValue) throw new Error(`Ù…Ø­ØªÙˆØ§ÛŒ Ù…ØªÙ†ÛŒ Ø®Ø§Ù„ÛŒ`);
                        let parsedValue = source.parser(rawValue);
                        if (isNaN(parsedValue) || parsedValue <= 0) throw new Error(`Ù…Ù‚Ø¯Ø§Ø± Ù†Ø§Ù…Ø¹ØªØ¨Ø± (${rawValue})`);
                        if (dataType === 'dollar' || dataType === 'iranGold') {
                            parsedValue /= 10;
                        } // Toman
                        const displayValue = dataType === 'gold' ? parsedValue.toFixed(2) : parsedValue.toFixed(0);
                        const inputElement = document.getElementById(inputId);
                        inputElement.value = displayValue;
                        inputElement.classList.add('input-autofilled');

                        // --- Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Cache ---
                        try {
                            localStorage.setItem(cacheKey, JSON.stringify({ value: parsedValue, timestamp: Date.now() }));
                            updateStatus(statusId, `ğŸ’¾ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ Ù¾Ù†Ù‡Ø§Ù† Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.`, 'info');
                        } catch (e) {
                            console.error("Cache save error:", e);
                            updateStatus(statusId, `âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ú©Ø´`, 'error');
                        }
                        // --------------------

                        success = true;
                        proxySuccess = true;
                        updateStatus(statusId, `âœ… Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø² Ø´Ø¨Ú©Ù‡: ${source.name} (Ù…Ù‚Ø¯Ø§Ø±: ${displayValue})`, 'success');
                        break; // Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ù„Ù‚Ù‡ Ù¾Ø±ÙˆÚ©Ø³ÛŒâ€ŒÙ‡Ø§

                    } catch (error) {
                        lastErrorForSource = error.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡';
                        currentProxyIndex = (currentProxyIndex + 1) % CORS_PROXIES.length;
                    }
                } // Ù¾Ø§ÛŒØ§Ù† Ø­Ù„Ù‚Ù‡ Ù¾Ø±ÙˆÚ©Ø³ÛŒâ€ŒÙ‡Ø§

                if (proxySuccess) {
                    break; // Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ù„Ù‚Ù‡ Ù…Ù†Ø§Ø¨Ø¹
                } else {
                    updateStatus(statusId, `â—ï¸ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² ${source.name} Ù†Ø§Ù…ÙˆÙÙ‚ (Ø®Ø·Ø§: ${lastErrorForSource})`, 'error');
                    currentProxyIndex = 0;
                }
            } // Ù¾Ø§ÛŒØ§Ù† Ø­Ù„Ù‚Ù‡ Ù…Ù†Ø§Ø¨Ø¹

            if (!success) { updateStatus(statusId, overallFailureMessage, 'error'); }

            // --- Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ø¨Ù‡ Ø­Ø§Ù„Øª Ø¹Ø§Ø¯ÛŒ ---
            if (button) button.disabled = false;
            if (buttonText) buttonText.classList.remove('hidden');
            if (spinner) spinner.classList.add('hidden');
        }

        function calculate() {
            const inputs = validateInputs(); if (!inputs) { document.getElementById('results').innerHTML = ''; return; }
            const { ounce, dollar, iran } = inputs;
            const gram24PriceToman = (ounce / 31.1035) * dollar;
            const calculatedGram18PriceToman = (gram24PriceToman * 0.75).toFixed(0);
            const difference = iran - calculatedGram18PriceToman;
            const percentage = calculatedGram18PriceToman > 0 ? ((difference / calculatedGram18PriceToman) * 100).toFixed(2) : 0;
            showResult(calculatedGram18PriceToman, iran, percentage, ounce, dollar); // Ø§Ø±Ø³Ø§Ù„ Ù…Ù‚Ø§Ø¯ÛŒØ± ÙˆØ±ÙˆØ¯ÛŒ
        }
        function getStatus(percentage) {
            percentage = parseFloat(percentage);
            if (percentage < -3) return ['ÙØ±ØµØª Ø¹Ø§Ù„ÛŒ Ø®Ø±ÛŒØ¯ ğŸš€', 'bg-green-100 text-green-800 border border-green-300'];
            if (percentage < -1) return ['Ø§Ø­ØªÙ…Ø§Ù„Ø§ ÙØ±ØµØª Ø®Ø±ÛŒØ¯ âœ…', 'bg-green-100 text-green-800 border border-green-300'];
            if (percentage <= 1) return ['Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ù…Ø¹Ù‚ÙˆÙ„ / ØªØ¹Ø§Ø¯Ù„ âš–ï¸', 'bg-blue-100 text-blue-800 border border-blue-300'];
            if (percentage <= 4) return ['Ú©Ù…ÛŒ Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø² Ø§Ù†ØªØ¸Ø§Ø± / Ø§Ø­ØªÛŒØ§Ø· âš ï¸', 'bg-yellow-100 text-yellow-800 border border-yellow-300'];
            if (percentage <= 8) return ['Ø§Ø­ØªÙ…Ø§Ù„ ÙˆØ¬ÙˆØ¯ Ø­Ø¨Ø§Ø¨ / Ø±ÛŒØ³Ú© Ù…ØªÙˆØ³Ø· â—ï¸', 'bg-red-100 text-red-800 border border-red-300'];
            return ['Ø±ÛŒØ³Ú© Ø¨Ø§Ù„Ø§ / Ø­Ø¨Ø§Ø¨ Ù‚Ø§Ø¨Ù„ ØªÙˆØ¬Ù‡ âŒ', 'bg-red-100 text-red-800 border border-red-300 font-bold'];
        }
        function showResult(calculatedPriceToman, actualPriceToman, percentage, ouncePrice, dollarPrice) {
            const [statusText, statusClass] = getStatus(percentage);
            const difference = actualPriceToman - calculatedPriceToman;
            const differenceText = difference >= 0 ? `Ø¨Ø§Ù„Ø§ØªØ± (+${difference.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†)` : `Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± (${difference.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†)`;

            const resultHTML = `
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-3 text-center text-gray-800">Ù†ØªØ§ÛŒØ¬ ØªØ­Ù„ÛŒÙ„ Ù‚ÛŒÙ…Øª Ø·Ù„Ø§ (ØªÙˆÙ…Ø§Ù†)</h3>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="text-center border-l border-gray-200 pl-2">
                            <p class="text-sm text-gray-500">Ù‚ÛŒÙ…Øª Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒØ´Ø¯Ù‡ Ù‡Ø± Ú¯Ø±Ù… Û±Û¸ Ø¹ÛŒØ§Ø±<br/>(Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ù†Ø³ Ø¬Ù‡Ø§Ù†ÛŒ Ùˆ Ø¯Ù„Ø§Ø±)</p>
                            <p class="text-xl font-bold text-blue-600 mt-1">${Number(calculatedPriceToman).toLocaleString('fa-IR')} <span class="text-xs">ØªÙˆÙ…Ø§Ù†</span></p>
                        </div>
                        <div class="text-center border-r border-gray-200 pr-2">
                            <p class="text-sm text-gray-500">Ù‚ÛŒÙ…Øª Ù‡Ø± Ú¯Ø±Ù… Û±Û¸ Ø¹ÛŒØ§Ø±<br/>(Ø¨Ø§Ø²Ø§Ø± Ø§ÛŒØ±Ø§Ù†)</p>
                            <p class="text-xl font-bold text-green-600 mt-1">${Number(actualPriceToman).toLocaleString('fa-IR')} <span class="text-xs">ØªÙˆÙ…Ø§Ù†</span></p>
                        </div>
                    </div>
                    <div class="mb-2 text-center text-sm text-gray-600">
                        Ø¨Ø± Ø§Ø³Ø§Ø³ Ù‚ÛŒÙ…Øª Ø§Ù†Ø³ Ø¬Ù‡Ø§Ù†ÛŒ: ${parseFloat(ouncePrice).toLocaleString('en-US')} Ø¯Ù„Ø§Ø± Ùˆ Ù‚ÛŒÙ…Øª Ø¯Ù„Ø§Ø±: ${parseFloat(dollarPrice).toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†.
                    </div>
                    <div class="text-center mb-4 p-3 rounded-lg ${statusClass}">
                        <p class="font-bold text-lg">${statusText}</p>
                        <p class="text-sm mt-1">Ù‚ÛŒÙ…Øª Ø¨Ø§Ø²Ø§Ø± Ø§ÛŒØ±Ø§Ù† ${percentage}% (${differenceText}) Ù†Ø³Ø¨Øª Ø¨Ù‡ Ù‚ÛŒÙ…Øª Ø¬Ù‡Ø§Ù†ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
                    </div>
                    <div class="mb-4">
                        <canvas id="percentageChart" width="200" height="80"></canvas>
                    </div>
                    <div class="mt-3 text-xs text-gray-500 text-center">
                        ØªØ­Ù„ÛŒÙ„ Ø¯Ø± ØªØ§Ø±ÛŒØ® ${new Date().toLocaleDateString('fa-IR', { timeZone: 'Asia/Tehran' })} Ø³Ø§Ø¹Øª ${new Date().toLocaleTimeString('fa-IR', { timeZone: 'Asia/Tehran' })} Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.
                    </div>
                </div>`;
            document.getElementById('results').innerHTML = resultHTML;

            // Ø±Ø³Ù… Ù†Ù…ÙˆØ¯Ø§Ø±
            const ctx = document.getElementById('percentageChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Ø¯Ø±ØµØ¯ Ø§Ø®ØªÙ„Ø§Ù'],
                    datasets: [{
                        label: 'Ø¯Ø±ØµØ¯',
                        data: [percentage],
                        backgroundColor: percentage >= 0 ? 'rgba(255, 99, 132, 0.2)' : 'rgba(75, 192, 192, 0.2)',
                        borderColor: percentage >= 0 ? 'rgba(255, 99, 132, 1)' : 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.toFixed(2) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        function validateInputs() {
            const inputs = { ounce: document.getElementById('ouncePrice').value, dollar: document.getElementById('dollarPrice').value, iran: document.getElementById('iranGold').value };
            const errors = [];
            if (!inputs.ounce || isNaN(parseFloat(inputs.ounce)) || parseFloat(inputs.ounce) <= 0) errors.push("Ù‚ÛŒÙ…Øª Ø§Ù†Ø³ Ø¬Ù‡Ø§Ù†ÛŒ");
            if (!inputs.dollar || isNaN(parseFloat(inputs.dollar)) || parseFloat(inputs.dollar) <= 0) errors.push("Ù‚ÛŒÙ…Øª Ø¯Ù„Ø§Ø± (ØªÙˆÙ…Ø§Ù†)");
            if (!inputs.iran || isNaN(parseFloat(inputs.iran)) || parseFloat(inputs.iran) <= 0) errors.push("Ù‚ÛŒÙ…Øª Ø·Ù„Ø§ÛŒ Ø§ÛŒØ±Ø§Ù† (ØªÙˆÙ…Ø§Ù†)");
            if (errors.length > 0) {
                alert(`Ù„Ø·ÙØ§Ù‹ Ù…Ù‚Ø§Ø¯ÛŒØ± Ù…Ø¹ØªØ¨Ø± Ùˆ Ù…Ø«Ø¨Øª Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ§Ø±Ø¯ Ø²ÛŒØ± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:\n- ${errors.join('\n- ')}`);
                return false;
            }
            return { ounce: parseFloat(inputs.ounce), dollar: parseFloat(inputs.dollar), iran: parseFloat(inputs.iran) };
        }
        function resetAll() {
            const inputIds = ['ouncePrice', 'dollarPrice', 'iranGold'];
            inputIds.forEach(id => {
                const element = document.getElementById(id);
                element.value = '';
                element.classList.remove('input-autofilled');
            });
            document.getElementById('results').innerHTML = '';
            clearStatus('goldStatus');
            clearStatus('dollarStatus');
            clearStatus('iranGoldStatus');
            // Optionally clear cache on reset?
            // localStorage.removeItem('cache_gold');
            // localStorage.removeItem('cache_dollar');
            // localStorage.removeItem('cache_iranGold');
        }

        // Ø°Ø®ÛŒØ±Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± ÙˆØ±ÙˆØ¯ÛŒ Ø¯Ø± localStorage
        function saveInputs() {
            const ounce = document.getElementById('ouncePrice').value;
            const dollar = document.getElementById('dollarPrice').value;
            const iran = document.getElementById('iranGold').value;
            localStorage.setItem('lastOuncePrice', ounce);
            localStorage.setItem('lastDollarPrice', dollar);
            localStorage.setItem('lastIranGold', iran);
        }

        // Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ù…Ù‚Ø§Ø¯ÛŒØ± ÙˆØ±ÙˆØ¯ÛŒ Ø§Ø² localStorage Ø¯Ø± Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ ØµÙØ­Ù‡
        window.onload = function() {
            const lastOunce = localStorage.getItem('lastOuncePrice');
            const lastDollar = localStorage.getItem('lastDollarPrice');
            const lastIran = localStorage.getItem('lastIranGold');
            if (lastOunce) document.getElementById('ouncePrice').value = lastOunce;
            if (lastDollar) document.getElementById('dollarPrice').value = lastDollar;
            if (lastIran) document.getElementById('iranGold').value = lastIran;
        };

        function shareResults() {
            const calculatedPriceElement = document.querySelector('#results .text-blue-600');
            const actualPriceElement = document.querySelector('#results .text-green-600');
            const percentageDiffElement = document.querySelector('#results .rounded-lg p:last-child');
            const differenceTextElement = document.querySelector('#results .rounded-lg p:last-child'); // Ø§Ø² Ù‡Ù…ÛŒÙ† Ø¹Ù†ØµØ± Ø¨Ø±Ø§ÛŒ Ù…ØªÙ† Ø§Ø®ØªÙ„Ø§Ù Ù‡Ù… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…

            if (!calculatedPriceElement || !actualPriceElement || !percentageDiffElement || !differenceTextElement) {
                alert('Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯.');
                return;
            }

            const calculatedPrice = calculatedPriceElement.textContent.trim().replace(' ØªÙˆÙ…Ø§Ù†', '').replace(/Ù¬/g, '');
            const actualPrice = actualPriceElement.textContent.trim().replace(' ØªÙˆÙ…Ø§Ù†', '').replace(/Ù¬/g, '');
            const percentageMatch = percentageDiffElement.textContent.trim().match(/(\d+\.?\d*)%/);
            const percentage = percentageMatch ? parseFloat(percentageMatch[1]) : NaN; // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø¹Ø¯Ø¯ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± getStatus
            const differenceFullText = differenceTextElement.textContent.trim();
            const differenceMatch = differenceFullText.match(/(\((.*?)\))/);
            let differenceValue = 'Ù†Ø§Ù…Ø´Ø®Øµ';
            if (differenceMatch && differenceMatch[2]) {
                const diffText = differenceMatch[2];
                if (diffText.includes('+')) {
                    differenceValue = diffText.split('+')[1].replace(' ØªÙˆÙ…Ø§Ù†', '').replace(/Ù¬/g, '').trim();
                } else if (diffText.includes('-')) {
                    differenceValue = diffText.split('-')[1].replace(' ØªÙˆÙ…Ø§Ù†', '').replace(/Ù¬/g, '').trim();
                }
            }

            let statusText = '';
            if (!isNaN(percentage)) {
                if (percentage < -3) statusText = 'ÙØ±ØµØª Ø¹Ø§Ù„ÛŒ Ø®Ø±ÛŒØ¯ ğŸš€';
                else if (percentage < -1) statusText = 'Ø§Ø­ØªÙ…Ø§Ù„Ø§ ÙØ±ØµØª Ø®Ø±ÛŒØ¯ âœ…';
                else if (percentage <= 1) statusText = 'Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ù…Ø¹Ù‚ÙˆÙ„ / ØªØ¹Ø§Ø¯Ù„ âš–ï¸';
                else if (percentage <= 4) statusText = 'Ú©Ù…ÛŒ Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø² Ø§Ù†ØªØ¸Ø§Ø± / Ø§Ø­ØªÛŒØ§Ø· âš ï¸';
                else if (percentage <= 8) statusText = 'Ø§Ø­ØªÙ…Ø§Ù„ ÙˆØ¬ÙˆØ¯ Ø­Ø¨Ø§Ø¨ / Ø±ÛŒØ³Ú© Ù…ØªÙˆØ³Ø· â—ï¸';
                else statusText = 'Ø±ÛŒØ³Ú© Ø¨Ø§Ù„Ø§ / Ø­Ø¨Ø§Ø¨ Ù‚Ø§Ø¨Ù„ ØªÙˆØ¬Ù‡ âŒ';
            } else {
                statusText = 'ÙˆØ¶Ø¹ÛŒØª Ù†Ø§Ù…Ø´Ø®Øµ';
            }

            const isHigher = parseFloat(actualPrice) > parseFloat(calculatedPrice);
            const differenceToShow = differenceValue !== 'Ù†Ø§Ù…Ø´Ø®Øµ' ? differenceValue : 'Ù†Ø§Ù…Ø´Ø®Øµ';
            const higherLowerText = isHigher && differenceToShow !== 'Ù†Ø§Ù…Ø´Ø®Øµ' ? 'Ú¯Ø±Ø§Ù† Ø§Ø³Øª' : (differenceToShow !== 'Ù†Ø§Ù…Ø´Ø®Øµ' ? 'Ø§Ø±Ø²Ø§Ù† Ø§Ø³Øª' : 'Ù†Ø§Ù…Ø´Ø®Øµ');

            const shareText = `Ù‚ÛŒÙ…Øª Ø·Ù„Ø§ 18 Ø¹ÛŒØ§Ø± Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ù†Ø³ Ø¬Ù‡Ø§Ù†ÛŒ ${calculatedPrice.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù† Ù…ÛŒ Ø¨Ø§Ø´Ø¯. Ù‚ÛŒÙ…Øª Ø¯Ø§Ø®Ù„ÛŒ Ø·Ù„Ø§ Ø¯Ø± Ø§ÛŒØ±Ø§Ù† ${actualPrice.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù† Ù…ÛŒØ¨Ø§Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ø·Ù„Ø§ÛŒ Ø¯Ø§Ø®Ù„ÛŒ ${differenceToShow} ØªÙˆÙ…Ø§Ù† Ø§Ø² Ø·Ù„Ø§ÛŒ Ø¬Ù‡Ø§Ù†ÛŒ ${higherLowerText} Ú©Ù‡ Ø§ÛŒÙ† Ù…Ù‚Ø¯Ø§Ø± Ø¨Ø±Ø§Ø¨Ø± Ø§Ø³Øª Ø¨Ø§ ${isNaN(percentage) ? 'Ù†Ø§Ù…Ø´Ø®Øµ' : percentage.toFixed(2)}% - ÙˆØ¶Ø¹ÛŒØª: ${statusText}`;

            navigator.clipboard.writeText(shareText).then(() => {
                alert('Ù…ØªÙ† Ø¨Ø±Ø§ÛŒ Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø¯Ø± Ú©Ù„ÛŒÙ¾â€ŒØ¨ÙˆØ±Ø¯ Ú©Ù¾ÛŒ Ø´Ø¯!');
            }).catch(err => {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† Ù…ØªÙ†: ', err);
                alert('Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ø§Ù…Ú©Ø§Ù† Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† Ù…ØªÙ† ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.');
            });
        }

        // Ú©Ø¯ Ø«Ø¨Øª Service Worker Ø­Ø°Ù Ø´Ø¯

        // ÛŒÚ© Ø¨Ù‡Ø¨ÙˆØ¯ Ú©ÙˆÚ†Ú©: Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª ØªØ­Ù„ÛŒÙ„ Ø¨Ù‡ ÙˆÙ‚Øª ØªÙ‡Ø±Ø§Ù†
        // (Ø¨Ù‡ ØªØ§Ø¨Ø¹ showResult Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯: timeZone: 'Asia/Tehran')

        // Ø¨Ù‡Ø¨ÙˆØ¯ Ú©ÙˆÚ†Ú©: Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù†ØªØ§ÛŒØ¬ Ù‚Ø¨Ù„ÛŒ Ù‡Ù†Ú¯Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨Ø§ ÙˆØ±ÙˆØ¯ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø±
        // (Ø¨Ù‡ Ø§Ø¨ØªØ¯Ø§ÛŒ ØªØ§Ø¨Ø¹ calculate Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯)

    </script>
</body>
</html>